<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#005A51">
    <meta name="apple-mobile-web-app-title" content="Vocab Training">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">

    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3-theme-teal.css">

    <title>Vocab' Training</title>
    
    <!-- If Javascript is disabled -->
    <noscript>
        <style type="text/css">
            .pageContainer {display:none;}
        </style>
    </noscript>
</head>
<body onload="checkCookiesOnStart();">

<!-- Header -->
<header class="w3-container w3-theme w3-padding-8" id="myHeader">
    <div class="w3-center">
        <h1 class="w3-xxlarge">Vocab' training</h1>
        <div class="w3-padding-8">
            <button class="w3-btn w3-xlarge w3-theme-dark w3-hover-teal" 
                    onclick="document.getElementById('modalChooseTheme').style.display='block'" 
                    style="font-weight:900;">START ...</button>
        </div>
    </div>
</header>
    
<!-- If Javascript is disabled -->
<noscript>
    <div class="w3-center w3-padding-64">
        <span class="w3-tag w3-xxxlarge w3-padding-64 w3-round-large w3-red w3-center">
            Please enable JavaScript !<br>
            Instructions <a href="http://www.enable-javascript.com/" target="_blank">here</a>.
        </span>
    </div>
</noscript>

<div class="pageContainer">
    <div id="onStartDiv" class="w3-center w3-padding-64">
        <span class="w3-tag w3-xxxlarge w3-padding-64 w3-round-large w3-teal w3-center">
            CLICK ON<br>
            START !
        </span>
    </div>

    <!-- Modal -->
    <div id="modalChooseTheme" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-theme"> 
                <span onclick="document.getElementById('modalChooseTheme').style.display='none'" class="w3-closebtn">&times;</span>
                <h4>Choose your theme ...</h4>
            </header>
            <div class="w3-padding">
                <ul class="w3-ul w3-border w3-hoverable">
                    <li id="cat_1" onclick="updateCat('cat_1')" class="w3-theme cat">Work</li>
                    <li id="cat_2" onclick="updateCat('cat_2')" class="cat">Languages</li>
                    <li id="cat_3" onclick="updateCat('cat_3')" class="cat">Globalization</li>
                    <li id="cat_4" onclick="updateCat('cat_4')" class="cat">Education</li>
                    <li id="cat_5" onclick="updateCat('cat_5')" class="cat">Obesity</li>
                    <li id="cat_6" onclick="updateCat('cat_6')" class="cat">Information, Media, Internet</li>
                    <li id="cat_7" onclick="updateCat('cat_7')" class="cat">The Environment</li>
                    <li id="cat_8" onclick="updateCat('cat_8')" class="cat">The Environment (Part. 2)</li>
                    <li id="cat_9" onclick="updateCat('cat_9')" class="cat">Playing God</li>
                    <li id="cat_10" onclick="updateCat('cat_10')" class="cat">Innovation</li>
                </ul>
                <br>
                <button class="w3-btn w3-theme-dark w3-hover-teal" 
                        onclick="showCatOptions()" 
                        style="font-weight:700;">Next</button>
            </div>
        </div>
    </div>

    <div id="modalChooseSubject" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-top">
            <header class="w3-container w3-theme"> 
                <span onclick="document.getElementById('modalChooseSubject').style.display='none'" class="w3-closebtn">&times;</span>
                <h4 id="modalThemeTitle">Title</h4>
                <h4>Choose your subject:</h4>
            </header>
            <div class="w3-padding">
                <!-- This list is filled by the showCatOptions() js function -->
                <ul id="modalThemeList" class="w3-ul w3-border w3-hoverable">
                </ul>
                <!-- Some options -->

                <form class="w3-row w3-padding">
                    <div class="w3-third w3-padding">
                        <input id="radio_entofr" class="w3-radio" type="radio" name="transdir" checked
                               onclick="setCookie('radio_entofr', document.getElementById('radio_entofr').checked, 30);">
                        <label class="w3-validate">English to French</label>
                    </div>
                    <div class="w3-third w3-padding">
                        <input id="radio_frtoen" class="w3-radio" type="radio" name="transdir"
                                onclick="setCookie('radio_frtoen', document.getElementById('radio_frtoen').checked, 30);">
                        <label class="w3-validate">French to English</label>
                    </div>
                    <div class="w3-third w3-padding">
                        <input id="radio_both" class="w3-radio" type="radio" name="transdir"
                                onclick="setCookie('radio_both', document.getElementById('radio_both').checked, 30);">
                        <label class="w3-validate">Both</label>
                    </div>
                </form>

                <div class="w3-row w3-padding">
                    <div class="w3-third w3-padding">
                        <input id="limitButton" class="w3-check" type="checkbox"
                            onclick="setCookie('limitButton', document.getElementById('limitButton').checked, 30);if(document.getElementById('limitButton').checked){document.getElementById('numberOfWords').disabled=false;}else{document.getElementById('numberOfWords').disabled=true;}">
                        <label class="w3-validate">Limit of words:</label>
                    </div>
                    <div class="w3-rest w3-padding">
                        <input id="numberOfWords" class="w3-input w3-border" type="number" placeholder="Number of words" value="20" min="1" max="5000"
                            onchange="setCookie('numberOfWords', document.getElementById('numberOfWords').value, 30);" disabled>
                      </div>
                </div>

                <div class="w3-row w3-padding">
                    <div class="w3-col w3-padding" style="width:200px;">
                        <button class="w3-btn w3-theme-dark w3-hover-teal" 
                        onclick="startTraining()" 
                        style="font-weight:700;">Start</button>
                    </div>
                    <div class="w3-rest w3-padding">
                        <input id="randomButton" class="w3-check" type="checkbox"
                            onclick="setCookie('randomButton', document.getElementById('randomButton').checked, 30);">
                        <label class="w3-validate">Random</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="trainingDiv" class="w3-row-padding w3-animate-right" style="display:none;">
        <div class="w3-card-4 w3-padding-top" style="min-height:460px">
            <header class="w3-container w3-indigo">
                <h3 id="trainingTitle">Theme: Subject</h3>
            </header>

            <form id="trainingForm" class="w3-container" action="javascript:void(0);" autocomplete="off" >
                <h3 id="trainingWord" class="w3-text-indigo w3-animate-right">word</h3>

                <label id="trainingTranslateLabel" class="w3-label w3-text-indigo">Translation in French:</label>
                <input id="trainingUserInput" class="w3-input w3-border" type="text" autocomplete="off">
                <br>
                <button id="trainingButtonNext" class="w3-btn w3-indigo" onclick="processNextWord()">Next</button>
            </form>
        </div>
    </div>

    <div id="resultsDiv" class="w3-row-padding w3-animate-right" style="display:none;">
        <div class="w3-card-4 w3-padding-top" style="min-height:460px">
            <header class="w3-container w3-teal">
                <h3>Your results:</h3>
            </header>
            <!-- Show the score of the user -->
            <div class="w3-progress-container w3-padding">
                <div id="resultsProgress" class="w3-progressbar w3-red" style="width:0%">
                    <div id="resultsProgressLabel" class="w3-center w3-text-white">0%</div>
                </div>
            </div>

            <h3 class="w3-padding">Entries:</h3>

            <!-- Show the entries of the user (filled in javascript) -->
            <table id="resultsHistoryTable" class="w3-table w3-border w3-padding">
            </table>

        </div>
    </div>
</div><!-- pageContainer end -->


<!-- Try to support IE, but no matter if it doesn't work, nobody under 40 uses it !-->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>  
<![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/2014.01.31/classList.min.js"></script>
<script src="js/papaparse.min.js"></script>
<script src="js/latinise.min.js"></script>
<script src="js/string_score.min.js"></script>
<script>
/*jslint browser:true */
/*global Papa */
    
/*
 * ----- Support section ------
 */

// From http://stackoverflow.com/a/8813472/3570066
if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function(obj, start) {
        for (var i = (start || 0), j = this.length; i < j; i++) {
            if (this[i] === obj) { return i; }
        }
        return -1;
    };
}

// From https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/Trim
if (!String.prototype.trim) {
    String.prototype.trim = function () {
        return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
    };
}
    
/*
 * ----- Cookie Stuff -----
 */

// From W3Schools
function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    document.cookie = cname + "=" + cvalue + "; " + "expires=" + d.toUTCString();
}

// From W3Schools
function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    var i;
    for(i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function checkCookiesOnStart() {
    if(navigator.cookieEnabled === true) {
        var random = getCookie("randomButton");
        if(random == 'true') {
            document.getElementById('randomButton').checked = true;    
        }
        
        var limitBut = getCookie("limitButton");
        if(limitBut == 'true') {
            document.getElementById('limitButton').checked = true;
            document.getElementById('numberOfWords').disabled = false;
        }
        
        var limit = getCookie("numberOfWords");
        if(limit !== "") {
            document.getElementById('numberOfWords').value = parseInt(limit);    
        }
        
        var rd_entofr = getCookie("radio_entofr");
        if(rd_entofr == 'true') {
            document.getElementById('radio_entofr').checked = true;    
        }
        var rd_frtoen = getCookie("radio_frtoen");
        if(rd_frtoen == 'true') {
            document.getElementById('radio_frtoen').checked = true;    
        }
        var rd_both = getCookie("radio_both");
        if(rd_both == 'true') {
            document.getElementById('radio_both').checked = true;    
        }
    }
}
    
/*
 * ----- General functions -----
 */
    
// From http://stackoverflow.com/a/6274398/3570066
function shuffle(array) {
    var counter = array.length;

    // While there are elements in the array
    while (counter > 0) {
        // Pick a random index
        var index = Math.floor(Math.random() * counter);

        // Decrease counter by 1
        counter--;

        // And swap the last element with it
        var temp = array[counter];
        array[counter] = array[index];
        array[index] = temp;
    }
    return array;
}

// From http://stackoverflow.com/a/1026087/3570066
String.prototype.capitalizeFirstLetter = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
};
    
String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};

// percent must be an integer in range [0,100]
function moveProgressBarTo(percent) {
    var elem = document.getElementById("resultsProgress");   
    var width = 0;
    elem.style.width = "0%";
    elem.className = "w3-progressBar w3-red";
    var id = setInterval(frame, 10);
    function frame() {
        if (width >= percent) {
             clearInterval(id);
        } else {
            width++; 
            elem.style.width = width + '%'; 
            document.getElementById("resultsProgressLabel").innerHTML = width * 1  + '%';
              
            // Update color
            if(width == 40) {
                elem.className = "w3-progressBar w3-deep-orange";
            } else if(width == 65) {
                elem.className = "w3-progressBar w3-orange";
            } else if(width == 85) {
                elem.className = "w3-progressBar w3-green";
            }
        }
    }
}
    
// Retrieve a list from a csv file using papa parse
function getCSVList(url, onFinishedFunction) {
    Papa.parse(url, {
        download: true,
        delimiter: "=",
        complete: function(results, file) {
            // Papa parse appends an empty item at the end of the list
            // So, remove it
            if(results.data[results.data.length-1][0] === "") {
                results.data.pop();
            }
            
            onFinishedFunction(results.data);
        }
    });
}
    
// Return a concatanation of all subjects for a category
function getAllSubjects(catId, onFinishedFunction) {
    getCSVList("themes/" + catId + "/map.csv", function(data) {
        var mainList = [];
        var subCount = data.length;
        var i = 0;
        var handleSubRequest = function(subData) {
            mainList = mainList.concat(subData);
            i = i+1;
            if(i >= subCount) {
                // All subjects have been retrieved
                onFinishedFunction(mainList);
            } else {
                getCSVList("themes/" + catId + "/" + data[i][0] + ".csv", handleSubRequest);
            }
        };
        
        getCSVList("themes/" + catId + "/" + data[i][0] + ".csv", handleSubRequest);
    });
}
    
/*
 * ----- Highlight the selected item -----
 */

function updateCat(id) {
    var el = document.getElementsByClassName("cat");
    var i;
    for (i = 0; i < el.length; i++) {
        el[i].className = "cat";
    }
    document.getElementById(id).className = "cat w3-theme";
}

function updateSub(id) {
    var el = document.getElementsByClassName("sub");
    var i;
    for (i = 0; i < el.length; i++) {
        el[i].className = "sub";
    }
    document.getElementById(id).className = "sub w3-theme";
}
    
/*
 * ----- Categories / themes  -----
 */

// Return a list with: [id, text]
function selectedCat() {
    var catId = "";
    var catText = "";
    var el = document.getElementsByClassName("cat");
    var i;
    for (i = 0; i < el.length; i++) {
        if (el[i].classList.contains("w3-theme")) {
            catId = el[i].id;
            catText = el[i].innerHTML;
            break;
        }
    }
    return [catId, catText];
}

// Return a list with: [id, text]
function selectedSub() {
    var subId = "";
    var subText = "";
    var el = document.getElementsByClassName("sub");
    var i;
    for (i = 0; i < el.length; i++) {
        if (el[i].classList.contains("w3-theme")) {
            subId = el[i].id;
            subText = el[i].innerHTML;
            break;
        }
    }
    return [subId, subText];
}

function showCatOptions() {
    // Search selected cat
    var cat = selectedCat();
    document.getElementById("modalThemeTitle").innerHTML = cat[1];
    
    // Now parse the corresponding map file
    getCSVList("themes/" + cat[0] + "/map.csv", function(data) {
        var subList = document.getElementById("modalThemeList");
        // Remove previous subject entries
        while (subList.hasChildNodes()) {   
            subList.removeChild(subList.firstChild);
        }
            
        var i;
        for(i = 0; i < data.length; i++) {
            var sub = data[i];
            if(sub[0] !== "") {
                if(i === 0) {
                    subList.innerHTML = subList.innerHTML + '<li id="' + sub[0] + '" onclick="updateSub(' + "'" + sub[0] + "'" + ')" class="w3-theme sub">' + sub[1] + '</li>';
                } else {
                    subList.innerHTML = subList.innerHTML + '<li id="' + sub[0] + '" onclick="updateSub(' + "'" + sub[0] + "'" + ')" class="sub" >' + sub[1] + '</li>';
                }
            }
        }
        
        // Add a "all" element
        subList.innerHTML = subList.innerHTML + '<li id="sub_all" onclick="updateSub(' + "'sub_all'" + ')"  class="sub">All subjects !</li>';
        
        // Show the modal
        document.getElementById('modalChooseSubject').style.display='block';
    });
}

//
// Both three list have the same size
var currentWordsArray = [];
// For each element, contains true or false
var successMap = [];
var userInputsHistory = [];
// For each word contains 0 or 1:
//  - 0: user enters the word in french
//  - 1: user enters the word in english
var translateDirection = [];

var currentId;

function startTraining() {
    // Called when the word list have been retrieved
    var handleWordsList = function(data) {
        currentWordsArray = data;
            
        successMap = [];
        userInputsHistory = [];
        currentId = 0;
            
        // Check if the array must be shuffled
        if(document.getElementById('randomButton').checked) {
            currentWordsArray = shuffle(currentWordsArray);
        }
            
        // Check if the user select a limit
        if(document.getElementById('limitButton').checked) {
            var wordsLimit = document.getElementById('numberOfWords').value;
            if(wordsLimit < currentWordsArray.length) {
                currentWordsArray = currentWordsArray.slice(0, wordsLimit);
            }
        }
            
        var i;
        // Check the translation direction
        if(document.getElementById('radio_entofr').checked) {
            // User answers in french
            for(i = 0; i < currentWordsArray.length; i++) {
                translateDirection.push(0);
            }
        } else if(document.getElementById('radio_frtoen').checked) {
            // User answers in english
            for(i = 0; i < currentWordsArray.length; i++) {
                translateDirection.push(1);
            }
        } else if(document.getElementById('radio_both').checked) {
            // Users answers both in english or french
            for(i = 0; i < currentWordsArray.length; i++) {
                translateDirection.push(Math.round(Math.random()));
            }
        }
            
        if(translateDirection[0] === 0) {
            document.getElementById("trainingTranslateLabel").innerHTML = "Translation in <b>French</b>:";
        } else {
            document.getElementById("trainingTranslateLabel").innerHTML = "Translation in <b>English</b>:";
        }
            
        document.getElementById("trainingWord").innerHTML = currentWordsArray[0][translateDirection[0]].capitalizeFirstLetter().replaceAll(";", ",");
        document.getElementById("trainingButtonNext").innerHTML = "Next (" + (currentId + 1) + "/" + currentWordsArray.length + ")";
        document.getElementById('trainingUserInput').value = "";
            
        document.getElementById('onStartDiv').style.display='none';
        document.getElementById('resultsDiv').style.display='none';
            
        // Show the training part
        document.getElementById('trainingDiv').style.display='block';
            
        // Hide the modal
        document.getElementById('modalChooseSubject').style.display='none';
        document.getElementById('modalChooseTheme').style.display='none';
    };
    
    var cat = selectedCat();
    var sub = selectedSub();
    
    document.getElementById("trainingTitle").innerHTML = cat[1] + ": " + sub[1];
    
    if(sub[0] == "sub_all") {
        getAllSubjects(cat[0], handleWordsList);
    } else {
        getCSVList("themes/" + cat[0] + "/" + sub[0] + ".csv", handleWordsList);
    }
}

function removeUselessWords(str, isEnglish) {
    var s = str.replaceAll("-", " ").replaceAll('"', " ").replaceAll("‘", " ").replaceAll("’", " ").replaceAll("»", " ").replaceAll("«", " ").replaceAll(",", " ").replace("/", " ");
    s = s.replaceAll("”", " ").replaceAll("“", " ").replaceAll("\\?", "").replaceAll("!", "").replaceAll(";", " ").replaceAll(":", " ").replaceAll("'", " ").replaceAll("\\.", "");
    s = s.replaceAll(" %", "%");
    
    if(isEnglish === true) {
        if(s.startsWith("a ")){s=s.substring(2);}
        else if(s.startsWith("an ")){s=s.substring(3);}
        else if(s.startsWith("the ")){s=s.substring(4);}
        else if(s.startsWith("to ")){s=s.substring(3);}
        s = s.replace("somebody", "sb").replace("something", "sth").replace("(gb)", "").replace("(us)", "");
    } else {
        if(s.startsWith("le ")){s=s.substring(3);}
        else if(s.startsWith("la ")){s=s.substring(3);}
        else if(s.startsWith("les ")){s=s.substring(4);}
        else if(s.startsWith("un ")){s=s.substring(3);}
        else if(s.startsWith("une ")){s=s.substring(4);}
        else if(s.startsWith("des ")){s=s.substring(4);}
        else if(s.startsWith("de ")){s=s.substring(3);}
        else if(s.startsWith("du ")){s=s.substring(3);}
        else if(s.startsWith("de la ")){s=s.substring(6);}
        s = s.replaceAll("l ", "");
        s = s.replace("quelqu un", "qqn").replace("quelque chose", "qqch");
    }
    
    return s.trim();
}
    
function removeParenthesis(str, inside) {
    if (inside === true) {
        // Remove everything inside parenthesis
        return str.replace(/ *\([^)]*\) */g, "").trim();
    } else {
        return str.replace("(", "").replace(")", "").trim();
    }
}

function processNextWord() {
    // First step: check current word
    var input = document.getElementById('trainingUserInput').value;
    userInputsHistory.push(input);
    
    input = input.trim();
    // Remove double spaces
    input = input.replace(/ +(?= )/g,'');
    // Remove accents
    input = input.latinise();
    input = input.toLowerCase();
    input = removeUselessWords(input, translateDirection[currentId] === 1); // 1 means fr to en, so answer is in english
    
    // Split translations in several ones 
    var translations = currentWordsArray[currentId][1-translateDirection[currentId]].split(";");
    var match = false;
    var i;
    for(i = 0; i < translations.length; i++) {
        var trans = translations[i];
        trans = trans.trim();
        trans = trans.replace(/ +(?= )/g,'');
        trans = trans.latinise();
        trans = trans.toLowerCase();
        trans = removeUselessWords(trans, translateDirection[currentId] === 1);
        
        // Check if the translation contains parenthesis
        if (trans.indexOf("(") > -1) {
            var trans2 = removeParenthesis(trans, true);
            if(trans2 == input || trans2.score(input) >= 0.8) {
                match = true;
                break;
            }
            trans = removeParenthesis(trans, false);
        }
        
        // Standard check (with words inside parenthesis)
        if(trans == input || trans.score(input) >= 0.8) {
            match = true;
            break;
        }
    }
    
    successMap.push(match);
    
    // Second step: move to the next word
    currentId += 1;
    if(currentId < currentWordsArray.length) {
        // Update information on screen
        //document.getElementById('trainingWord').classList.toggle('Sw3-animate-right');
        //document.getElementById('trainingWord').classList.toggle('w3-animate-right');
        
        if(translateDirection[currentId] === 0) {
            document.getElementById("trainingTranslateLabel").innerHTML = "Translation in <b>French</b>:";
        } else {
            document.getElementById("trainingTranslateLabel").innerHTML = "Translation in <b>English</b>:";
        }
        document.getElementById("trainingWord").innerHTML = currentWordsArray[currentId][translateDirection[currentId]].capitalizeFirstLetter().replaceAll(";", ",");
        document.getElementById("trainingButtonNext").innerHTML = "Next (" + (currentId + 1) + "/" + currentWordsArray.length + ")";
        document.getElementById('trainingUserInput').value = "";
    } else {
        // The user reach the end of the words list
        document.getElementById('trainingDiv').style.display='none'; // Hide training div
        document.getElementById('resultsDiv').style.display='block'; // Show results div
        
        // Update progress bar
        var percent = 0;
        for(i = 0; i < successMap.length; i++) {
            if(successMap[i]) {
                percent += 1;
            }
        }
        percent = parseInt((percent/successMap.length)*100);
        moveProgressBarTo(percent);
        
        //Update entries list
        var results = document.getElementById("resultsHistoryTable");
        while (results.hasChildNodes()) {   
            results.removeChild(results.firstChild);
        }
        
        results.innerHTML = results.innerHTML + '<tr><th>English</th><th>French</th><th>Your answer</th></tr>';
        
        for(i = 0; i < successMap.length; i++) {
            if(successMap[i]) {
                results.innerHTML = results.innerHTML + '<tr class="w3-green"><td>' + currentWordsArray[i][0].capitalizeFirstLetter().replaceAll(";", ",") + '</td><td>' + currentWordsArray[i][1].capitalizeFirstLetter().replaceAll(";", ",") + '</td><td>' + userInputsHistory[i] + '</td></tr>';
            } else {
                results.innerHTML = results.innerHTML + '<tr class="w3-red"><td>' + currentWordsArray[i][0].capitalizeFirstLetter().replaceAll(";", ",") + '</td><td>' + currentWordsArray[i][1].capitalizeFirstLetter().replaceAll(";", ",") + '</td><td>' + userInputsHistory[i] + '</td></tr>';
            }
        }
    }
    
    // Avoid refresh
    return false;
}
</script>
</body>
</html>